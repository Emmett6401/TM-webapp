<!DOCTYPE html>
<html>
<head>
    <title>웹캠 이미지 분류기</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-slate-800 flex justify-center items-center h-screen text-slate-100;
        }

        .card {
            @apply bg-slate-700 p-8 rounded-2xl shadow-2xl flex flex-col items-center max-w-lg w-full;
        }

        h1 {
            @apply text-3xl font-bold text-white mb-2;
        }

        .subtitle {
            @apply text-base text-slate-400 mb-6 font-light;
        }

        .webcam-container {
            @apply border-4 border-slate-600 rounded-lg overflow-hidden w-full;
            position: relative;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .webcam-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .button-group {
            @apply flex gap-4 mt-6;
        }
        
        button {
            @apply px-8 py-3 rounded-full font-semibold transition-all duration-300 transform hover:scale-105;
            @apply focus:outline-none focus:ring-4 focus:ring-opacity-50;
        }

        #start-button {
            @apply bg-emerald-500 text-white shadow-lg shadow-emerald-500/50 hover:bg-emerald-600;
            @apply focus:ring-emerald-500;
        }

        #stop-button {
            @apply bg-rose-500 text-white shadow-lg shadow-rose-500/50 hover:bg-rose-600;
            @apply focus:ring-rose-500;
        }

        .status-container {
            @apply w-full mt-6 text-center;
        }

        .status-text {
            @apply text-lg font-medium mb-2;
        }

        .loading-bar-wrapper {
            @apply h-2 bg-slate-600 rounded-full overflow-hidden;
        }

        .loading-bar {
            @apply h-full bg-sky-400 transition-all duration-300;
        }

        .label-container div {
            @apply my-1 py-2 px-4 bg-slate-600 rounded-md font-normal text-sm;
        }
    </style>
</head>
<body>

    <div class="card">
        <h1>웹캠 이미지 분류기</h1>
        <p class="subtitle">Teachable Machine 모델을 사용해 물체를 실시간으로 분류합니다.</p>
        
        <div id="initial-load-content">
            <div id="status-text" class="status-text">모델을 로딩 중입니다...</div>
            <div id="loading-bar-wrapper" class="loading-bar-wrapper">
                <div id="loading-bar" class="loading-bar" style="width: 0%;"></div>
            </div>
        </div>

        <div id="main-app-content" class="hidden flex flex-col items-center w-full">
            <div class="webcam-container" id="webcam-container"></div>
            <div class="button-group">
                <button id="start-button" onclick="init()">시작</button>
                <button id="stop-button" onclick="stopWebcam()" disabled>종료</button>
            </div>
            <div id="label-container" class="label-container hidden"></div>
        </div>
    </div>

    <script type="text/javascript">
        const URL = "https://teachablemachine.withgoogle.com/models/GoNhD-Ca-/";

        let model, webcam, maxPredictions, loopId;
        let isPredicting = false;
        
        const statusText = document.getElementById('status-text');
        const loadingBar = document.getElementById('loading-bar');
        const mainAppContent = document.getElementById('main-app-content');
        const initialLoadContent = document.getElementById('initial-load-content');
        const labelContainer = document.getElementById('label-container');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const webcamContainer = document.getElementById("webcam-container");
        const loadingBarWrapper = document.getElementById('loading-bar-wrapper');

        async function loadModel() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            
            try {
                model = await tmImage.load(modelURL, metadataURL, {
                    onProgress: (progress) => {
                        const percent = Math.floor(progress * 100);
                        statusText.innerText = `모델 로딩 중... ${percent}%`;
                        loadingBar.style.width = `${percent}%`;
                    }
                });
                maxPredictions = model.getTotalClasses();
                
                // 모델 로딩이 끝나면 로딩 콘텐츠를 숨기고 메인 앱 콘텐츠를 보여줌
                initialLoadContent.classList.add('hidden');
                mainAppContent.classList.remove('hidden');
                
            } catch (err) {
                statusText.innerText = '모델 로딩 실패. 콘솔을 확인해주세요.';
                loadingBarWrapper.classList.add('hidden');
                console.error(err);
            }
        }

        async function init() {
            if (isPredicting) return;
            
            const flip = true;
            webcam = new tmImage.Webcam(400, 300, flip);

            try {
                await webcam.setup();
                await webcam.play();
                isPredicting = true;
                loopId = window.requestAnimationFrame(loop);

                webcamContainer.innerHTML = '';
                webcamContainer.appendChild(webcam.canvas);
                
                startButton.disabled = true;
                stopButton.disabled = false;
                
                labelContainer.classList.remove('hidden');
                statusText.innerText = '실시간 예측 중...';
                
                labelContainer.innerHTML = '';
                for (let i = 0; i < maxPredictions; i++) {
                    labelContainer.appendChild(document.createElement("div"));
                }
            } catch (err) {
                console.error("웹캠을 시작하는 데 실패했습니다:", err);
                alert("웹캠 접근을 허용해주세요. 또는 브라우저 설정을 확인해주세요.");
                isPredicting = false;
                startButton.disabled = false;
            }
        }

        function stopWebcam() {
            if (!isPredicting) return;
            
            webcam.stop();
            isPredicting = false;
            window.cancelAnimationFrame(loopId);
            
            webcamContainer.innerHTML = '';
            statusText.innerText = '종료되었습니다. 다시 시작하려면 "시작" 버튼을 누르세요.';
            labelContainer.classList.add('hidden');
            
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        async function loop() {
            if (!isPredicting) return;
            
            webcam.update();
            await predict();
            loopId = window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }
        }
        
        window.onload = loadModel;
    </script>
</body>
</html>
